buildscript {
    repositories {
        google()
        mavenCentral()
    }

    dependencies {
        classpath 'com.android.tools.build:gradle:7.4.2'
    }
}

repositories {
    google()
    mavenCentral()
}

apply plugin: 'com.android.application'

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar', '*.aar'])
}

ext {
    abi = System.getenv('ANDROID_ABI') ?: project.ext.properties['abi']
    ndkpath = System.getenv('KDECI_ANDROID_NDK_ROOT') ?: project.ext.properties['ndk.dir']  // TODO: Newer versions of Qt do support this dir
    installPrefix = System.getenv('KRITA_INSTALL_PREFIX')

    // Note about qtResPath vs qt5AndroidDir:
    //
    // qt5AndroidDir is set up by androiddeployqt and points to exact files
    // in _install directory, which is not available on the builder that builds
    // AppBundle packages, so we should access these files from a manually copied
    // location.
    //
    // tldr; at one time, either qt5AndroidDir or qtResPath is valid and points
    //       to the same files
    qtResPath = System.getenv('KRITA_BUILD_APPBUNDLE') ? 'extra-bundle-deps/android/java' : ""
}

task configure() {
    doLast {
        if (abi == null && !project.hasProperty("abi")) {
            logger.error('ANDROID_ABI not specified using the default one instead: arm64-v8a')
            abi = 'arm64-v8a'
        }

        def libs = new File(installPrefix, 'lib')
        if (!libs.exists()) {
            throw new FileNotFoundException('Krita libraries not found, please check if -p=krita-bin finished without errors')
        }
    }
}

task writeConfig(type: WriteProperties) {
    outputFile = file("gradle.properties")
    def gradleProperties = new Properties()
    outputFile.withInputStream { gradleProperties.load(it) }

    properties gradleProperties
    property 'abi', abi
    property 'ndk.dir', ndkpath
}

// copy libs(plugins) which start with krita*.so and rename
// them to start with `lib_`
task copyLibs(type: Copy) {
    from "$installPrefix/lib"
    into "libs/$abi"
    rename ('^krita(.*).so$', 'lib_krita$1.so')
}

task copyFonts(type: Copy) {
    from "$installPrefix/etc"
    into 'assets/etc/'
    include '**'
}

task copySDLJar(type: Copy) {
    from "$installPrefix/jar"
    into 'libs/'
    include 'SDL2Android.jar'
}

/*
 * androiddeployqt doesn't fully copy the directories. Hidden directories
 * to be specific. That's why we copy manually and then delete the partial
 * one it creates
 */
task copyAssets(type: Copy) {
    from "$installPrefix/share/"
    into 'assets/'
    include '**'
}

task copyLocaleFiles(type: Copy) {
    from "$installPrefix/share/locale"
    from "$installPrefix/translations"
    into 'assets/locale/'
    include '**'
}

task copyExtraMltFiles(type: Copy) {
    from "$installPrefix/share/mlt-7"
    into 'assets/mlt'
    include '**'
}

/*
 * Remove "share" folder in assets. It is copied both manually and by
 * androiddeployqt(reason in copyAssets task).
 */
task removeDuplicateAssets(type: Delete) {
    delete "assets/share"
}

def isPackagingAPK() {
    return gradle.taskGraph.hasTask(assembleRelease) || gradle.taskGraph.hasTask(assembleDebug)
}

android {
    compileSdkVersion androidCompileSdkVersion.toInteger()

    ndkPath ndkpath

    packagingOptions {
        jniLibs {
            useLegacyPackaging = true
        }
    }

    sourceSets {
        main {
            manifest.srcFile 'AndroidManifest.xml'
            java.srcDirs = [qt5AndroidDir + '/src', qtResPath + '/src', 'src', 'java']
            aidl.srcDirs = [qt5AndroidDir + '/src', qtResPath + '/src', 'src', 'aidl']
            res.srcDirs = [qt5AndroidDir + '/res',  qtResPath + '/res', 'res']
            resources.srcDirs = ['src']
            renderscript.srcDirs = ['src']
            assets.srcDirs = ['assets']
            jniLibs.srcDirs = ['libs', 'lib']
        }
        nightly {
            manifest.srcFile 'flavors/next/AndroidManifest.xml'
        }
        debug {
            manifest.srcFile 'flavors/debug/AndroidManifest.xml'
        }
    }

    buildTypes {
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'),
                    'proguard-rules.pro'
        }
        nightly {
            initWith release
            applicationIdSuffix ".next"
        }
        debug {
            applicationIdSuffix ".debug"
        }
    }

    // This is needed because, gradle by default ignores hidden assets.
    aaptOptions {
        ignoreAssetsPattern "!.foajasoie"
    }

    lintOptions {
        abortOnError false
    }

    project.ext.constant = 5

    def versionMajor    = 5
    def versionMinor    = 2

    /**
     * This version does **not** correspond to the patch version
     * of Krita. Instead, it is just incremented for every public
     * (including alpha and beta) release of versionMajor.versionMinor
     * branch
     */
    def versionRelease  = 26 // 5.2.2.1 was released with version '26', increment on releasing

    defaultConfig {
        targetSdkVersion 33
        minSdkVersion 23
        versionCode project.ext.constant * 1000000 + versionMajor * 10000 + versionMinor * 100 + versionRelease
        versionName "5.2.3-prealpha"
        archivesBaseName = System.getenv('KRITA_BUILD_APPBUNDLE') ? "krita-$versionName" : "krita-$abi-$versionName"
    }

    preBuild.dependsOn(configure)
    configure.onlyIf { isPackagingAPK() }
    configure.finalizedBy(writeConfig)
    configure.finalizedBy(copyLibs)
    configure.finalizedBy(copyFonts)
    configure.finalizedBy(copyAssets)
    configure.finalizedBy(copyLocaleFiles)
    configure.finalizedBy(copySDLJar)
    configure.finalizedBy(copyExtraMltFiles)
    configure.finalizedBy(removeDuplicateAssets)
}

dependencies {
    implementation 'com.android.billingclient:billing:5.0.0'
    implementation 'androidx.annotation:annotation:1.4.0'
    implementation files("libs/SDL2Android.jar")
}
